!function(a){"use strict";function b(a){this.el=a,this.overlay=this.el.querySelector(".nl-overlay"),this.fields=[],this.fldOpen=-1,this._init()}function c(a,b,c,d){this.form=a,this.elOriginal=b,this.pos=d,this.type=c,this._create(),this._initEvents()}var d=a.document;String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),b.prototype={_init:function(){var a=this;Array.prototype.slice.call(this.el.querySelectorAll("select")).forEach(function(b,d){a.fldOpen++,a.fields.push(new c(a,b,"dropdown",a.fldOpen))}),Array.prototype.slice.call(this.el.querySelectorAll('input:not([type="hidden"])')).forEach(function(b,d){a.fldOpen++,a.fields.push(new c(a,b,"input",a.fldOpen))}),this.overlay.addEventListener("click",function(b){a._closeFlds()}),this.overlay.addEventListener("touchstart",function(b){a._closeFlds()})},_closeFlds:function(){-1!==this.fldOpen&&this.fields[this.fldOpen].close()}},c.prototype={_create:function(){"dropdown"===this.type?this._createDropDown():"input"===this.type&&this._createInput()},_createDropDown:function(){var a=this;this.fld=d.createElement("div"),this.fld.className="nl-field nl-dd",this.toggle=d.createElement("a"),this.toggle.innerHTML=this.elOriginal.options[this.elOriginal.selectedIndex].innerHTML,this.toggle.className="nl-field-toggle",this.optionsList=d.createElement("ul");var b="";Array.prototype.slice.call(this.elOriginal.querySelectorAll("option")).forEach(function(c,d){b+=a.elOriginal.selectedIndex===d?'<li class="nl-dd-checked">'+c.innerHTML+"</li>":"<li>"+c.innerHTML+"</li>",a.elOriginal.selectedIndex===d&&(a.selectedIdx=d)}),this.optionsList.innerHTML=b,this.fld.appendChild(this.toggle),this.fld.appendChild(this.optionsList),this.elOriginal.parentNode.insertBefore(this.fld,this.elOriginal),this.elOriginal.style.display="none"},_createInput:function(){this.fld=d.createElement("div"),this.fld.className="nl-field nl-ti-text",this.toggle=d.createElement("a"),this.toggle.innerHTML=this.elOriginal.getAttribute("value")?this.elOriginal.getAttribute("value"):this.elOriginal.getAttribute("placeholder"),this.toggle.className="nl-field-toggle",this.optionsList=d.createElement("ul"),this.getinput=d.createElement("input"),this.getinput.setAttribute("type",this.elOriginal.getAttribute("type")?this.elOriginal.getAttribute("type"):""),this.getinput.setAttribute("placeholder",this.elOriginal.getAttribute("placeholder")),this.getinput.setAttribute("value",this.elOriginal.getAttribute("value")?this.elOriginal.getAttribute("value"):""),this.getinputWrapper=d.createElement("li"),this.getinputWrapper.className="nl-ti-input",this.inputsubmit=d.createElement("button"),this.inputsubmit.className="nl-field-go",this.inputsubmit.innerHTML="Go",this.getinputWrapper.appendChild(this.getinput),this.getinputWrapper.appendChild(this.inputsubmit),this.example=d.createElement("li"),this.example.className="nl-ti-example",this.example.innerHTML=this.elOriginal.getAttribute("data-subline"),this.optionsList.appendChild(this.getinputWrapper),this.optionsList.appendChild(this.example),this.fld.appendChild(this.toggle),this.fld.appendChild(this.optionsList),this.elOriginal.parentNode.insertBefore(this.fld,this.elOriginal),this.elOriginal.style.display="none"},_initEvents:function(){var a=this;if(this.toggle.addEventListener("click",function(b){b.preventDefault(),b.stopPropagation(),a._open()}),this.toggle.addEventListener("touchstart",function(b){b.preventDefault(),b.stopPropagation(),a._open()}),"dropdown"===this.type){var b=Array.prototype.slice.call(this.optionsList.querySelectorAll("li"));b.forEach(function(c,d){c.addEventListener("click",function(d){d.preventDefault(),a.close(c,b.indexOf(c))}),c.addEventListener("touchstart",function(d){d.preventDefault(),a.close(c,b.indexOf(c))})})}else"input"===this.type&&(this.getinput.addEventListener("keydown",function(b){13===b.keyCode&&a.close()}),this.inputsubmit.addEventListener("click",function(b){b.preventDefault(),a.close()}),this.inputsubmit.addEventListener("touchstart",function(b){b.preventDefault(),a.close()}))},_open:function(){if(this.open)return!1;this.open=!0,this.form.fldOpen=this.pos;this.fld.className+=" nl-field-open",this.form.el.className+=" nl-form-field-open"},close:function(a,b){if(!this.open)return!1;if(this.open=!1,this.form.fldOpen=-1,this.fld.className=this.fld.className.replace(/\b nl-field-open\b/,""),this.form.el.className=this.form.el.className.replace(/\b nl-form-field-open\b/,""),"dropdown"===this.type){if(a){var c=this.optionsList.children[this.selectedIdx];c.className="",a.className="nl-dd-checked",this.toggle.innerHTML=a.innerHTML,this.selectedIdx=b,this.elOriginal.value=this.elOriginal.children[this.selectedIdx].value,$(this.elOriginal).trigger("change")}}else"input"===this.type&&(this.getinput.blur(),this.toggle.innerHTML=""!==this.getinput.value.trim()?this.getinput.value:this.getinput.getAttribute("placeholder"),this.elOriginal.value=this.getinput.value)}},a.NLForm=b}(window);var Boda={Views:{},Models:{}};Boda.Models.User=Backbone.Model.extend({id:1,localStorage:new Backbone.LocalStorage("BodaAM"),defaults:{id:1,name:"",surname:"",rsvp:"yes",email:"",transportIn:"car",sushi:"maybe",vegetarian:"no",alergies:"no",alergiesDesc:"",copes:"0",night:"home",room:"2pax",shared:"",transportOut:"car",comments:""}}),Boda.Views.AppView=Backbone.View.extend({el:"#content",events:{},initialize:function(){var a=this;this.steps=["Intro","Form1","Form2","Form3","Form4","Outro"],this.current=0,this.model=new Boda.Models.User,this.model.fetch({success:function(b){console.log("Success on fetch",b),a.renderStep()},error:function(b){console.log("Error on fetch",b),a.renderStep()}})},renderStep:function(a){var a=a||"forward",b=["rotateFoldRight","rotateUnfoldRight","rotateFoldLeft","rotateUnfoldLeft"].join(" "),c="forward"===a?"rotateUnfoldRight":"rotateUnfoldLeft",d="forward"===a?"rotateFoldLeft":"rotateFoldRight";this.currentStep=this.steps[this.current],0!==this.current&&this.$el.removeClass(b).addClass(d),_.delay(_.bind(function(){this.currentView=new Boda.Views[this.currentStep+"View"]({model:this.model,parent:this}),this.$el.html(this.currentView.render().$el),this.currentView.afterRender(),0!==this.current&&this.$el.removeClass(b).addClass(c)},this),500)},nextStep:function(){this.current=this.current<this.steps.length-1?this.current+1:this.current,this.renderStep("forward")},prevStep:function(){this.current=this.current>0?this.current-1:0,this.renderStep("backward")}}),Boda.Views.BasePage=Backbone.View.extend({events:{"click .nl-next":"nextStep","click .nl-prev":"prevStep"},initialize:function(a){this.parent=a.parent},render:function(){return this.setElement($.parseHTML(this.template(this.model.toJSON()))),this},afterRender:function(){return this},nextStep:function(){this.parent.nextStep()},prevStep:function(){this.parent.prevStep()}}),Boda.Views.FormView=Boda.Views.BasePage.extend({afterRender:function(){var a=this;this.$el.find("select").each(function(){$(this).val(a.model.get($(this).attr("name")))}),this.nlform=new NLForm(document.getElementById("nl-form"))},save:function(){var a=this;this.$el.find(".mdl").each(function(){a.model.set($(this).attr("name"),$(this).val())}),this.model.save()},nextStep:function(){this.save(),this.parent.nextStep()},prevStep:function(){this.save(),this.parent.prevStep()}}),Boda.Views.IntroView=Boda.Views.BasePage.extend({el:"#intro",template:_.template($("#intro-template").html().trim())}),Boda.Views.Form1View=Boda.Views.FormView.extend({el:"#form-1",template:_.template($("#form-1-template").html().trim()),nextStep:function(){this.save()&&this.parent.nextStep()},save:function(){var a=this,b=[];return this.$el.find("input.mdl").each(function(){if(""===$(this).val()){var a="";switch($(this).attr("name")){case"name":a="Nom";break;case"surname":a="Cognom";break;case"email":a="Email"}b.push(a)}}),b.length?(console.log(b),alert("Has d'omplir els següents camps: "+b.join(", ")),!1):(this.$el.find(".mdl").each(function(){a.model.set($(this).attr("name"),$(this).val())}),this.model.save(),!0)}}),Boda.Views.Form2View=Boda.Views.FormView.extend({el:"#form-2",template:_.template($("#form-2-template").html().trim())}),Boda.Views.Form3View=Boda.Views.FormView.extend({el:"#form-3",template:_.template($("#form-3-template").html().trim()),events:{"click .nl-next":"nextStep","click .nl-prev":"prevStep","change select[name=alergies]":"alergies"},alergies:function(a){var b=$(a.target),c=this.$el.find("#alergiesDesc");"yes"===b.val()?c.addClass("showIt"):(c.removeClass("showIt"),c.find("textarea").val(""))}}),Boda.Views.Form4View=Boda.Views.FormView.extend({el:"#form-4",template:_.template($("#form-4-template").html().trim()),events:{"click .nl-next":"nextStep","click .nl-prev":"prevStep","change select[name=night]":"hotel"},hotel:function(a){var b=$(a.target),c=this.$el.find("#hotel-detail");"hotel"===b.val()?c.addClass("showIt"):(c.removeClass("showIt"),this.model.set("room","none"))}}),Boda.Views.OutroView=Boda.Views.BasePage.extend({el:"#outro",template:_.template($("#outro-template").html().trim()),nextStep:function(){var a=this;this.model.set("comments",$("textarea").val()),$("#loading").addClass("show"),console.log("Submit!",a.model.toJSON()),$.ajax("http://sheetsu.com/apis/cc8627c5",{method:"POST",dataType:"json",data:this.model.toJSON(),crossDomain:!0}).done(function(b){console.log("Done",b),$("#loading").removeClass("show"),a.$el.html('<h1 style="text-align:center">Les teves respostes s\'han enviat correctament, gràcies!</h1>')}).error(function(a){console.log("Error!",a)})}}),$(function(){Boda.App=new Boda.Views.AppView});